<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Football Mini App</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --text:#e9eeff; --muted:#a9b2d6;
      --accent:#43d17a; --accent2:#5aa6ff; --danger:#ff5a6a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:radial-gradient(1000px 600px at 30% -10%, #1b2a66 0, transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, #155a43 0, transparent 55%),
                  var(--bg); color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 90px;}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .brand{font-weight:800;letter-spacing:.4px}
    .pill{background:rgba(255,255,255,.08);padding:8px 12px;border-radius:999px;display:flex;gap:10px;align-items:center}
    .pill small{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
    .card{background:rgba(18,26,51,.92);border:1px solid rgba(255,255,255,.08);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:0;border-radius:14px;padding:12px 14px;font-weight:700;cursor:pointer;color:#061024;background:linear-gradient(135deg,var(--accent),#a6ffcb);}
    .btn2{border:0;border-radius:14px;padding:12px 14px;font-weight:700;cursor:pointer;color:#071126;background:linear-gradient(135deg,var(--accent2),#b7dcff);}
    .btnGhost{border:1px solid rgba(255,255,255,.18);background:transparent;color:var(--text);border-radius:14px;padding:12px 14px;font-weight:700;cursor:pointer}
    .btnDanger{border:0;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;color:#21040a;background:linear-gradient(135deg,#ff5a6a,#ffb0b8);}
    .muted{color:var(--muted)}
    .tabs{position:fixed;left:0;right:0;bottom:0;background:rgba(6,10,22,.92);backdrop-filter: blur(10px);
          border-top:1px solid rgba(255,255,255,.08);display:flex;gap:6px;justify-content:center;padding:10px}
    .tab{padding:10px 12px;border-radius:14px;color:var(--muted);cursor:pointer;font-weight:700}
    .tab.active{color:var(--text);background:rgba(255,255,255,.08)}
    .section{display:none}
    .section.active{display:block}
    .list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}.list{grid-template-columns:1fr}}
    .player{display:flex;gap:10px;align-items:center}
    .player img{width:48px;height:48px;border-radius:12px;object-fit:cover;background:#0f1730;border:1px solid rgba(255,255,255,.08)}
    .player b{display:block}
    .badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
      padding:6px 10px;border-radius:999px;font-weight:800}
    .line{height:1px;background:rgba(255,255,255,.08);margin:12px 0}

    /* Pack animation */
    .packStage{display:flex;flex-direction:column;align-items:center;gap:10px}
    .pack{width:210px;height:270px;border-radius:22px;background:
      radial-gradient(140px 90px at 30% 20%, rgba(255,255,255,.35), transparent 60%),
      linear-gradient(135deg,#2b3bff,#43d17a);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 25px 60px rgba(0,0,0,.45);
      position:relative;overflow:hidden;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:26px;letter-spacing:.6px;
    }
    .pack::after{content:"";position:absolute;inset:-40px;transform:rotate(18deg);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);
      animation:shine 2.6s linear infinite;}
    @keyframes shine{0%{transform:translateX(-60%) rotate(18deg)}100%{transform:translateX(60%) rotate(18deg)}}
    .pack.opening{animation:shake .8s ease-in-out infinite}
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
    .reveal{display:none;margin-top:10px;width:100%}
    .reveal.active{display:block}
    .toast{margin-top:8px;color:var(--muted);min-height:20px}
    input,select{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);
      border-radius:14px;padding:12px 12px;outline:none;width:100%}
    label{font-size:13px;color:var(--muted);display:block;margin:8px 0 6px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">‚öΩ Football Mini App</div>
      <div class="pill">
        <div>ü™ô <b id="coins">0</b></div>
        <div>üéÅ <b id="packs">0</b></div>
        <div class="badge" id="vipBadge" style="display:none">‚≠ê VIP</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div><b id="uname">‚Äî</b> <span class="muted">ID:</span> <span id="uid">‚Äî</span></div>
            <div class="muted" id="levelLine">–£—Ä–æ–≤–µ–Ω—å: 1 ‚Ä¢ XP: 0/100</div>
          </div>
          <button class="btnGhost" id="refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="line"></div>
        <div class="row">
          <button class="btn" id="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</button>
          <button class="btn2" id="match">–°—ã–≥—Ä–∞—Ç—å –º–∞—Ç—á</button>
        </div>
        <div class="toast" id="toast"></div>
      </div>

      <div class="card">
        <div class="muted">–ö–ª—É–±</div>
        <div class="two">
          <div>
            <label>–í—ã–±–µ—Ä–∏ –∫–ª—É–±</label>
            <select id="clubSelect"></select>
          </div>
          <div>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—Ç–≤–æ–π —Å—Ç–∏–ª—å)</label>
            <input id="clubName" placeholder="–ù–∞–ø—Ä. Kings FC"/>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btnGhost" id="saveClub">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="toast" id="clubToast"></div>
      </div>
    </div>

    <!-- Sections -->
    <div class="card section active" id="sec_home" style="margin-top:12px">
      <div class="muted">–ö–æ–ª–ª–µ–∫—Ü–∏—è</div>
      <div class="list" id="inv"></div>
      <div class="toast" id="invToast"></div>
    </div>

    <div class="card section" id="sec_packs" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">–ü–∞–∫–∏</div>
          <div><b>–û—Ç–∫—Ä—ã–≤–∞–π –ø–∞–∫–∏ –∏ –ø–æ–ª—É—á–∞–π –∏–≥—Ä–æ–∫–æ–≤</b></div>
        </div>
      </div>
      <div class="line"></div>

      <div class="packStage">
        <div class="pack" id="packBox">PACK</div>
        <button class="btn2" id="openPackBtn">–û—Ç–∫—Ä—ã—Ç—å 1 –ø–∞–∫</button>
        <div class="toast" id="packToast"></div>

        <div class="reveal" id="reveal">
          <div class="card" style="background:rgba(255,255,255,.06)">
            <div class="player">
              <img id="rp_img" src="" alt="">
              <div>
                <b id="rp_name">‚Äî</b>
                <div class="muted"><span id="rp_pos">‚Äî</span> ‚Ä¢ Rating: <span id="rp_rat">‚Äî</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:12px">–ù—É–∂–Ω—ã –ø–∞–∫–∏? –ö—É–ø–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ ‚≠ê</div>
    </div>

    <div class="card section" id="sec_market" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">–ú–∞—Ä–∫–µ—Ç</div>
          <div><b>–ü–æ–∫—É–ø–∞–π/–ø—Ä–æ–¥–∞–≤–∞–π –∏–≥—Ä–æ–∫–æ–≤ –∑–∞ –º–æ–Ω–µ—Ç—ã</b></div>
        </div>
        <button class="btnGhost" id="loadMarket">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="line"></div>

      <div class="two">
        <div>
          <label>–ú–æ–π –∏–≥—Ä–æ–∫ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</label>
          <select id="sellPlayer"></select>
        </div>
        <div>
          <label>–¶–µ–Ω–∞ (–º–æ–Ω–µ—Ç—ã)</label>
          <input id="sellPrice" type="number" min="1" value="500"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn2" id="sellBtn">–í—ã—Å—Ç–∞–≤–∏—Ç—å</button>
      </div>
      <div class="toast" id="marketToast"></div>

      <div class="line"></div>
      <div class="muted">–õ–æ—Ç—ã</div>
      <div class="list" id="marketList"></div>
    </div>

    <div class="card section" id="sec_p2p" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">P2P —Å–¥–µ–ª–∫–∞ (–∏–≥—Ä–æ–∫ ‚Üî –º–æ–Ω–µ—Ç—ã)</div>
          <div><b>–ë–µ–∑–æ–ø–∞—Å–Ω–æ —á–µ—Ä–µ–∑ —ç—Å–∫—Ä–æ—É</b></div>
        </div>
        <button class="btnGhost" id="loadP2P">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="line"></div>

      <div class="two">
        <div>
          <label>–ò–≥—Ä–æ–∫ (–∏–∑ —Ç–≤–æ–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏)</label>
          <select id="p2pPlayer"></select>
        </div>
        <div>
          <label>–¶–µ–Ω–∞ (–º–æ–Ω–µ—Ç—ã)</label>
          <input id="p2pPrice" type="number" min="1" value="800"/>
        </div>
      </div>
      <div class="two">
        <div>
          <label>Buyer ID (Telegram user id)</label>
          <input id="p2pBuyer" placeholder="–ù–∞–ø—Ä. 123456789"/>
        </div>
        <div>
          <label>–ö–æ–º–∏—Å—Å–∏—è</label>
          <input id="p2pFeeHint" disabled value="–ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç +3%"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="p2pCreate">–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
      </div>
      <div class="toast" id="p2pToast"></div>

      <div class="line"></div>
      <div class="muted">–ú–æ–∏ —Å–¥–µ–ª–∫–∏</div>
      <div class="list" id="p2pList"></div>
    </div>

    <div class="card section" id="sec_shop" style="margin-top:12px">
      <div class="muted">–ú–∞–≥–∞–∑–∏–Ω ‚≠ê Telegram Stars</div>
      <div class="row" style="margin-top:10px">
        <button class="btn2" onclick="buy('pack_small')">–ü–∞–∫ Small (10‚≠ê)</button>
        <button class="btn2" onclick="buy('pack_big')">–ü–∞–∫ Big (45‚≠ê)</button>
        <button class="btn2" onclick="buy('coins_1k')">1000 –º–æ–Ω–µ—Ç (15‚≠ê)</button>
        <button class="btn2" onclick="buy('sub_vip')">VIP 30 –¥–Ω–µ–π (50‚≠ê)</button>
      </div>
      <div class="toast" id="shopToast"></div>
      <div class="muted" style="margin-top:12px">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏ ‚Äú–û–±–Ω–æ–≤–∏—Ç—å‚Äù, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –±–æ–Ω—É—Å—ã.</div>
    </div>

    <div class="card section" id="sec_tx" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
          <div><b>–ú–æ–Ω–µ—Ç—ã / –ø–∞–∫–∏ / XP / —Å–¥–µ–ª–∫–∏</b></div>
        </div>
        <button class="btnGhost" id="loadTx">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="line"></div>
      <div id="txList" class="list"></div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="home">üè†</div>
    <div class="tab" data-tab="packs">üéÅ</div>
    <div class="tab" data-tab="market">üõí</div>
    <div class="tab" data-tab="p2p">ü§ù</div>
    <div class="tab" data-tab="shop">‚≠ê</div>
    <div class="tab" data-tab="tx">üìú</div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const $ = (id)=>document.getElementById(id);

  let userId = 0;
  let username = "";
  let inventory = [];

  function showToast(id, text){
    $(id).textContent = text || "";
  }

  function setActive(tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');

    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    $('sec_'+tab).classList.add('active');
  }

  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick = ()=> setActive(t.dataset.tab);
  });

  async function api(path, method='GET', body=null){
    const opt = { method, headers: {'Content-Type':'application/json'} };
    if(body) opt.body = JSON.stringify(body);
    const r = await fetch(path, opt);
    const j = await r.json().catch(()=>({ok:false,error:'bad_json'}));
    if(!r.ok) throw j;
    return j;
  }

  function getTelegramUser(){
    // Telegram initData
    const u = tg?.initDataUnsafe?.user;
    if(u && u.id){
      return { id: u.id, username: u.username || (u.first_name||"") };
    }
    // fallback (test in browser):
    const qp = new URLSearchParams(location.search);
    const id = Number(qp.get('user_id') || 0);
    const un = qp.get('username') || '';
    return { id, username: un };
  }

  function renderInv(){
    const box = $('inv');
    box.innerHTML = '';
    if(!inventory.length){
      box.innerHTML = `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤. –û—Ç–∫—Ä—ã–≤–∞–π –ø–∞–∫–∏ üéÅ</div>`;
      $('sellPlayer').innerHTML = '';
      $('p2pPlayer').innerHTML = '';
      return;
    }
    inventory.forEach(it=>{
      const p = it.player;
      const qty = it.qty;
      const el = document.createElement('div');
      el.className = 'card';
      el.style.background = 'rgba(255,255,255,.05)';
      el.innerHTML = `
        <div class="player">
          <img src="${p.image_url || ''}" onerror="this.style.display='none'">
          <div style="flex:1">
            <b>${p.name}</b>
            <div class="muted">${p.pos} ‚Ä¢ Rating ${p.rating} ‚Ä¢ x${qty}</div>
          </div>
        </div>`;
      box.appendChild(el);
    });

    // dropdowns for selling/p2p: show only where qty>0
    const opts = inventory.map(it=>`<option value="${it.player.id}">${it.player.name} (x${it.qty})</option>`).join('');
    $('sellPlayer').innerHTML = opts;
    $('p2pPlayer').innerHTML = opts;
  }

  function renderMarket(items){
    const box = $('marketList');
    box.innerHTML = '';
    if(!items.length){
      box.innerHTML = `<div class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤</div>`;
      return;
    }
    items.forEach(it=>{
      const p = it.player;
      const el = document.createElement('div');
      el.className = 'card';
      el.style.background = 'rgba(255,255,255,.05)';
      el.innerHTML = `
        <div class="player">
          <img src="${p.image_url || ''}" onerror="this.style.display='none'">
          <div style="flex:1">
            <b>${p.name}</b>
            <div class="muted">${p.pos} ‚Ä¢ Rating ${p.rating}</div>
            <div class="row" style="margin-top:8px;justify-content:space-between">
              <div class="badge">ü™ô ${it.price}</div>
              <button class="btn" data-buy="${it.id}">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        </div>`;
      box.appendChild(el);
    });

    box.querySelectorAll('button[data-buy]').forEach(b=>{
      b.onclick = async ()=>{
        try{
          showToast('marketToast','–ü–æ–∫—É–ø–∫–∞...');
          await api('/api/market/buy','POST',{user_id:userId, listing_id:Number(b.dataset.buy)});
          showToast('marketToast','‚úÖ –ö—É–ø–ª–µ–Ω–æ!');
          await refreshAll();
          await loadMarket();
        }catch(e){
          showToast('marketToast','‚ùå '+(e.error||e.description||'–æ—à–∏–±–∫–∞'));
        }
      }
    });
  }

  function renderP2P(items){
    const box = $('p2pList');
    box.innerHTML = '';
    if(!items.length){
      box.innerHTML = `<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</div>`;
      return;
    }
    items.forEach(t=>{
      const p = t.player || {};
      const isSeller = Number(t.seller_id) === userId;
      const isBuyer = Number(t.buyer_id) === userId;
      const el = document.createElement('div');
      el.className = 'card';
      el.style.background = 'rgba(255,255,255,.05)';
      el.innerHTML = `
        <div class="player">
          <img src="${p.image_url || ''}" onerror="this.style.display='none'">
          <div style="flex:1">
            <b>#${t.id} ‚Ä¢ ${p.name || ('Player '+t.player_id)}</b>
            <div class="muted">–¶–µ–Ω–∞: ${t.price} ü™ô ‚Ä¢ fee: ${t.fee} ‚Ä¢ ${t.status}</div>
            <div class="muted">seller: ${t.seller_id} ‚Ä¢ buyer: ${t.buyer_id}</div>
            <div class="row" style="margin-top:8px">
              ${t.status==='pending' && isBuyer ? `<button class="btn" data-acc="${t.id}">–ü—Ä–∏–Ω—è—Ç—å</button>`:''}
              ${t.status==='pending' && isSeller ? `<button class="btnDanger" data-cancel="${t.id}">–û—Ç–º–µ–Ω–∏—Ç—å</button>`:''}
            </div>
          </div>
        </div>`;
      box.appendChild(el);
    });

    box.querySelectorAll('button[data-acc]').forEach(b=>{
      b.onclick = async ()=>{
        try{
          showToast('p2pToast','–ü—Ä–∏–Ω—è—Ç–∏–µ...');
          await api('/api/p2p_player/accept','POST',{trade_id:Number(b.dataset.acc), user_id:userId});
          showToast('p2pToast','‚úÖ –°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
          await refreshAll();
          await loadP2P();
        }catch(e){
          showToast('p2pToast','‚ùå '+(e.error||e.description||'–æ—à–∏–±–∫–∞'));
        }
      }
    });
    box.querySelectorAll('button[data-cancel]').forEach(b=>{
      b.onclick = async ()=>{
        try{
          showToast('p2pToast','–û—Ç–º–µ–Ω–∞...');
          await api('/api/p2p_player/cancel','POST',{trade_id:Number(b.dataset.cancel), user_id:userId});
          showToast('p2pToast','‚úÖ –û—Ç–º–µ–Ω–µ–Ω–æ');
          await refreshAll();
          await loadP2P();
        }catch(e){
          showToast('p2pToast','‚ùå '+(e.error||e.description||'–æ—à–∏–±–∫–∞'));
        }
      }
    });
  }

  function renderTx(items){
    const box = $('txList');
    box.innerHTML = '';
    if(!items.length){
      box.innerHTML = `<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`;
      return;
    }
    items.forEach(x=>{
      const dt = new Date((x.created_at||0)*1000);
      const el = document.createElement('div');
      el.className = 'card';
      el.style.background = 'rgba(255,255,255,.05)';
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <b>${x.kind}</b>
          <div class="badge">${x.delta>0?'+':''}${x.delta}</div>
        </div>
        <div class="muted" style="margin-top:6px">${x.note||''}</div>
        <div class="muted" style="margin-top:6px;font-size:12px">${dt.toLocaleString()}</div>`;
      box.appendChild(el);
    });
  }

  async function refreshAll(){
    const j = await api(`/api/bootstrap?user_id=${encodeURIComponent(userId)}&username=${encodeURIComponent(username)}`);
    $('coins').textContent = j.user.coins;
    $('packs').textContent = j.user.pack_credits;
    $('uid').textContent = j.user.user_id;
    $('uname').textContent = j.user.username || username || 'Player';
    $('levelLine').textContent = `–£—Ä–æ–≤–µ–Ω—å: ${j.user.level} ‚Ä¢ XP: ${j.user.xp}/${j.user.need}`;

    inventory = j.inventory || [];
    renderInv();

    if(j.user.vip){
      $('vipBadge').style.display = 'inline-flex';
    }else{
      $('vipBadge').style.display = 'none';
    }

    // clubs dropdown
    const clubs = j.clubs || [];
    const sel = $('clubSelect');
    if(!sel.dataset.loaded){
      sel.innerHTML = clubs.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      sel.dataset.loaded = "1";
    }
    if(j.user.club_id){
      sel.value = String(j.user.club_id);
      $('clubName').value = j.user.club_name || '';
    }

    // clear pack reveal
    $('reveal').classList.remove('active');
  }

  async function loadMarket(){
    try{
      const j = await api('/api/market/list');
      renderMarket(j.items||[]);
    }catch(e){
      showToast('marketToast','‚ùå –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∫–µ—Ç–∞');
    }
  }

  async function loadP2P(){
    try{
      const j = await api(`/api/p2p_player/list?user_id=${encodeURIComponent(userId)}`);
      renderP2P(j.items||[]);
    }catch(e){
      showToast('p2pToast','‚ùå –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ P2P');
    }
  }

  async function loadTx(){
    try{
      const j = await api(`/api/tx?user_id=${encodeURIComponent(userId)}&limit=60`);
      renderTx(j.items||[]);
    }catch(e){
      // ignore
    }
  }

  // actions
  $('refresh').onclick = async ()=>{ showToast('toast',''); await refreshAll(); };
  $('daily').onclick = async ()=>{
    try{
      showToast('toast','–ü–æ–ª—É—á–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É...');
      const j = await api('/api/daily/claim','POST',{user_id:userId});
      showToast('toast',`‚úÖ +${j.reward} –º–æ–Ω–µ—Ç`);
      await refreshAll();
    }catch(e){
      if(e.error==='cooldown'){
        const h = Math.ceil((e.left||0)/3600);
        showToast('toast',`‚è≥ –ü–æ–¥–æ–∂–¥–∏ ~${h}—á`);
      }else{
        showToast('toast','‚ùå '+(e.error||'–æ—à–∏–±–∫–∞'));
      }
    }
  };

  $('match').onclick = async ()=>{
    try{
      showToast('toast','–ú–∞—Ç—á...');
      const j = await api('/api/match/play','POST',{user_id:userId});
      showToast('toast',`${j.win?'üèÜ –ü–æ–±–µ–¥–∞':'üòÖ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ'} ‚Ä¢ +${j.reward} –º–æ–Ω–µ—Ç`);
      await refreshAll();
    }catch(e){
      showToast('toast','‚ùå '+(e.error||'–æ—à–∏–±–∫–∞'));
    }
  };

  $('saveClub').onclick = async ()=>{
    try{
      showToast('clubToast','–°–æ—Ö—Ä–∞–Ω—è—é...');
      await api('/api/set_club','POST',{
        user_id:userId,
        club_id:Number($('clubSelect').value),
        club_name:$('clubName').value
      });
      showToast('clubToast','‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      await refreshAll();
    }catch(e){
      showToast('clubToast','‚ùå '+(e.error||'–æ—à–∏–±–∫–∞'));
    }
  };

  // Packs animation
  async function openPack(){
    try{
      showToast('packToast','–û—Ç–∫—Ä—ã–≤–∞–µ–º...');
      $('packBox').classList.add('opening');
      $('reveal').classList.remove('active');
      await new Promise(r=>setTimeout(r, 900));

      const j = await api('/api/open_pack','POST',{user_id:userId});

      $('packBox').classList.remove('opening');
      const p = j.player;
      $('rp_name').textContent = p.name;
      $('rp_pos').textContent = p.pos;
      $('rp_rat').textContent = p.rating;
      $('rp_img').src = p.image_url || '';
      $('reveal').classList.add('active');
      showToast('packToast','‚úÖ –ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–µ–Ω!');
      await refreshAll();
    }catch(e){
      $('packBox').classList.remove('opening');
      showToast('packToast','‚ùå '+(e.error||'–æ—à–∏–±–∫–∞'));
    }
  }

  $('packBox').onclick = openPack;
  $('openPackBtn').onclick = openPack;

  // Market sell
  $('sellBtn').onclick = async ()=>{
    try{
      showToast('marketToast','–í—ã—Å—Ç–∞–≤–ª—è—é...');
      await api('/api/market/sell','POST',{
        user_id:userId,
        player_id:Number($('sellPlayer').value),
        price:Number($('sellPrice').value||0)
      });
      showToast('marketToast','‚úÖ –õ–æ—Ç —Å–æ–∑–¥–∞–Ω');
      await refreshAll();
      await loadMarket();
    }catch(e){
      showToast('marketToast','‚ùå '+(e.error||'–æ—à–∏–±–∫–∞'));
    }
  };

  $('loadMarket').onclick = loadMarket;

  // P2P create
  $('p2pCreate').onclick = async ()=>{
    try{
      showToast('p2pToast','–°–æ–∑–¥–∞—é —Å–¥–µ–ª–∫—É...');
      const buyer = Number(($('p2pBuyer').value||'').trim());
      if(!buyer) { showToast('p2pToast','‚ùå –í–≤–µ–¥–∏ buyer ID'); return; }

      const j = await api('/api/p2p_player/create','POST',{
        seller_id:userId,
        buyer_id:buyer,
        player_id:Number($('p2pPlayer').value),
        price:Number($('p2pPrice').value||0)
      });
      showToast('p2pToast',`‚úÖ –°–¥–µ–ª–∫–∞ #${j.trade_id} —Å–æ–∑–¥–∞–Ω–∞ (fee ${j.fee})`);
      await refreshAll();
      await loadP2P();
    }catch(e){
      showToast('p2pToast','‚ùå '+(e.error||'–æ—à–∏–±–∫–∞'));
    }
  };
  $('loadP2P').onclick = loadP2P;

  // Shop Stars
  async function buy(product){
    try{
      showToast('shopToast','–°–æ–∑–¥–∞—é —Å—Å—ã–ª–∫—É –æ–ø–ª–∞—Ç—ã...');
      const j = await api('/api/create_invoice','POST',{user_id:userId, product});
      showToast('shopToast','‚úÖ –û—Ç–∫—Ä—ã–≤–∞—é –æ–ø–ª–∞—Ç—É...');
      if(tg && tg.openInvoice){
        tg.openInvoice(j.url);
      }else{
        // fallback
        window.open(j.url, '_blank');
      }
    }catch(e){
      showToast('shopToast','‚ùå '+(e.error||e.description||'–æ—à–∏–±–∫–∞'));
    }
  }
  window.buy = buy;

  $('loadTx').onclick = loadTx;

  // init
  (async ()=>{
    const u = getTelegramUser();
    userId = u.id;
    username = u.username || "";

    if(!userId){
      alert("–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram. –ò–ª–∏ –æ—Ç–∫—Ä–æ–π —Ç–∞–∫: /web/index.html?user_id=123&username=test");
      return;
    }
    await refreshAll();
    await loadMarket();
    await loadP2P();
    await loadTx();
  })();
</script>
</body>
</html>
